## garuda-mail (Netcup VPS)

### General

This system mainly consists of the [simple-nixos-mailserver](https://gitlab.com/simple-nixos-mailserver/nixos-mailserver).
Its only purpose is providing a mail service to team members.
The current config looks like [this](https://gitlab.com/garuda-linux/infra-nix/-/blob/main/nixos/hosts/garuda-mail.nix?ref_type=heads#L47).
In case of issues, the [documentation](https://nixos-mailserver.readthedocs.io/en/latest/) can be consulted.

### Mail server setup

The mail server details are as follows:

- host: `mail.garudalinux.net`
- username: full email address
- password: given password
- incoming: IMAP via `993` (SSL)
- outgoing: SMTP via `587/465` (STARTTLS/SSL)

Additionally, it is possible to make use of the [Roundcube-powered web interface](https://mail.garudalinux.net).

### Roundcube

Roundcube is used to provide a web interface for our mail accounts.
It features a few plugins to enhance the general user experience.

#### Plugins

- attachment_reminder - reminds about forgotten attachments
- authres_status - checks for whether SPF/DKIM/DMARC match the sending domain
- carddav - allows adding a CardDAV contact book as source (eg. Nextcloud)
- contextmenu - adds a right click context menu to the most pages
- custom_from - allows customizing from address
- managesieve - allows managing Sieve rules, which automatically sort incoming mails based on rules
- newmail_notifier - new mail notifier for desktops
- persistent_login - allows storing a persistent login cookie for no more login prompts
- thunderbird_labels - shows Thunderbird labels
- zipdownload - allows downloading all attachments at once

### Backups

Backups are happening daily via Borg. A Hetzner storage box is used to store multiple generations of backups.

### Creating a new user

A new user can be created be adding a new `loginAccounts` value and supplying the password via `secrets`.
We make use of `hashedPasswordFile`, therefore, new hashes can be generated by running `nix-shell -p mkpasswd --run 'mkpasswd -sm bcrypt'`. Add it to the `secrets`, then execute `deploy` and `apply`.
Don't forget to commit both changes.

### Issues and their solution

#### Local DNS resolver failing to start

Simple NixOS mail server runs a local DNS server to prevent the log filling up with junk ([source](https://mailserver.readthedocs.io/en/latest/options.html#cmdoption-arg-mailserver.localDnsResolver)).
There can be cases of the persisted files need to be deleted in order for the service to recover from dumping core.
See [this issue](https://gitlab.nic.cz/knot/knot-resolver/-/issues/627) for reference.

### Nix expression

```nix
{{#include ../../../nixos/hosts/garuda-mail.nix}}
```

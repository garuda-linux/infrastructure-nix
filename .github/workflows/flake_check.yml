---
name: Run nix flake check
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
on:
  push:
    branches: [main]
    paths: [home-manager, nixos, overlays, flake.lock, flake.nix]
jobs:
  flake-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4
      - name: Install Nix 📦
        uses: cachix/install-nix-action@6a9a9e84a173d90b3ffb42c5ddaf9ea033fad011  # v23
        with:
          extra_nix_config: |
            accept-flake-config = true
            system-features = big-parallel kvm
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Supply dummy buildtime.json to let nix flake check pass 🧐
        run: sed -i 's&../secrets/secrets.json&../../assets/dummy.json&g' ./nixos/modules/garuda-lib.nix
      - name: Check flake 📝
        run: nix flake check
